<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <!-- 모바일 퍼스트 뷰포트 -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GAIA 모의고사 복습 사이트</title>
  <style>
    body { margin:0; padding:1rem; font-family:sans-serif; background:#f9f9f9; }
    .container { max-width:400px; margin:0 auto; background:white; padding:1rem; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    h1 { margin:0 0 .5rem; font-size:1.5rem; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .home-button { display:flex; align-items:center; cursor:pointer; margin-bottom:1rem; font-size:16px; color:#007bff; }
    .home-button img { width:16px; height:16px; margin-right:.25rem; }
    input, select, button { display:block; width:100%; padding:.75rem; font-size:1rem; margin:.5rem 0; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; }
    button { background:#007bff; color:white; border:none; }
    p.error { color:#d00; font-size:.9rem; margin:.25rem 0 0; }
    .menu-button { background:#28a745; color:white; font-size:1rem; margin-bottom:.75rem; }
    .menu-button:nth-child(2) { background:#ffc107; }
    .menu-button:nth-child(3) { background:#dc3545; }
    .report-img { display:block; max-width:100%; margin:0 auto; }
    .top-gif { display:block; width:60%; max-width:200px; margin:0 auto 1rem; }
    .hidden { display:none; }

    /* 리뷰 영역 */
    #questionImage, #explanationImage {
      display:block;
      max-width:100%;
      margin:1rem auto;
      border:1px solid #ccc;
      border-radius:4px;
    }
    #choiceButtons button {
      display:inline-block; width:18%; margin:1%; padding:.75rem 0;
      font-size:1rem; border:1px solid #007bff; border-radius:4px;
      background:white; color:#007bff; cursor:pointer;
    }
    #skipButton, #retryButton, #explainButton {
      display:block; margin:1rem auto; padding:.75rem; font-size:1rem;
    }
    #feedback { text-align:center; font-size:1.1rem; margin-top:.5rem; }
  </style>
</head>
<body>
  <div class="container">
    <!-- 홈 버튼 -->
    <div id="homeButton" class="home-button hidden">
      <img src="icons/home.png" alt="Home"> <span>처음으로</span>
    </div>

    <!-- 로그인 -->
    <div id="loginSection">
      <h1>GAIA 모의고사 복습 사이트</h1>
      <img src="globe.gif" class="top-gif" alt="Globe">
      <input id="loginId" placeholder="리클래스 ID 입력">
      <button id="loginBtn">로그인</button>
      <p id="loginMsg" class="error"></p>
    </div>

    <!-- 회차 선택 -->
    <div id="examSection" class="hidden">
      <h1>GAIA 모의고사 복습 사이트</h1>
      <select id="examSelect"></select>
      <button id="examBtn">회차 선택</button>
      <p id="examMsg" class="error"></p>
    </div>

    <!-- 메뉴 -->
    <div id="menuSection" class="hidden">
      <h1>GAIA 모의고사 복습 사이트</h1>
      <button id="menuReport" class="menu-button">1. 내 성적표 확인</button>
      <button id="menuReview" class="menu-button">2. 틀린 문제 다시 풀기</button>
      <button id="menuQuiz" class="menu-button">3. 틀린 문제 O/X 퀴즈</button>
      <p id="menuMsg" class="error"></p>
    </div>

    <!-- 성적표 -->
    <div id="reportSection" class="hidden">
      <h1>내 성적표</h1>
      <img id="reportImage" class="report-img" alt="성적표">
      <p id="reportMsg" class="error"></p>
    </div>

    <!-- 틀린 문제 다시 풀기 -->
    <div id="reviewSection" class="hidden">
      <h1>틀린 문제 다시 풀기</h1>
      <!-- 문제 이미지 -->
      <img id="questionImage" class="hidden" alt="문제 이미지">
      <!-- 설명 이미지 (초기 숨김) -->
      <img id="explanationImage" class="hidden" alt="해설 이미지">
      <!-- 선택지 -->
      <div id="choiceButtons"></div>
      <!-- 피드백 -->
      <p id="feedback"></p>
      <!-- 버튼들 -->
      <button id="retryButton" class="hidden">다시 풀어보기</button>
      <button id="explainButton" class="hidden">해설 확인하기</button>
      <button id="skipButton" class="hidden">SKIP</button>
      <p id="reviewMsg" class="error"></p>
    </div>

    <!-- OX 퀴즈 (준비 중) -->
    <div id="quizSection" class="hidden">
      <h1>틀린 문제 O/X 퀴즈 (준비 중)</h1>
    </div>
  </div>

  <script>
    let currentId='', currentExam='';
    let wrongList=[], currentWrongIndex=0;

    function hideAllSections(){
      ['loginSection','examSection','menuSection','reportSection','reviewSection','quizSection']
        .forEach(id=>document.getElementById(id).classList.add('hidden'));
    }
    function clearMessages(){
      ['loginMsg','examMsg','menuMsg','reportMsg','reviewMsg','feedback']
        .forEach(id=>document.getElementById(id).textContent='');
    }
    function hideReviewButtons(){
      ['retryButton','explainButton','skipButton'].forEach(id=>document.getElementById(id).classList.add('hidden'));
    }

    // 로그인
    document.getElementById('loginBtn').onclick=()=>{
      clearMessages(); hideReviewButtons();
      const id=document.getElementById('loginId').value.trim();
      if(!id){document.getElementById('loginMsg').textContent='ID를 입력하세요';return;}
      fetch(`/api/authenticate?id=${encodeURIComponent(id)}`)
      .then(r=>r.json()).then(d=>{
        if(d.authenticated){
          currentId=id; hideAllSections();
          document.getElementById('examSection').classList.remove('hidden');
          loadExams();
        } else document.getElementById('loginMsg').textContent='인증되지 않은 ID입니다';
      }).catch(()=>document.getElementById('loginMsg').textContent='인증 오류');
    };

    function loadExams(){
      fetch('/api/exams').then(r=>r.json()).then(exs=>{
        const sel=document.getElementById('examSelect'); sel.innerHTML='';
        if(!exs.length){sel.innerHTML='<option>회차없음</option>';return;}
        exs.forEach(e=>sel.add(new Option(e,e)));
      }).catch(()=>document.getElementById('examMsg').textContent='회차 로드 실패');
    }

    document.getElementById('examBtn').onclick=()=>{
      clearMessages(); hideReviewButtons();
      const ex=document.getElementById('examSelect').value;
      if(!ex){document.getElementById('examMsg').textContent='회차 선택';return;}
      fetch(`/api/check_exam?exam=${encodeURIComponent(ex)}&id=${encodeURIComponent(currentId)}`)
      .then(r=>r.json()).then(d=>{
        if(d.registered){
          currentExam=ex; hideAllSections();
          document.getElementById('menuSection').classList.remove('hidden');
          document.getElementById('homeButton').classList.remove('hidden');
        } else document.getElementById('examMsg').textContent=d.error;
      }).catch(()=>document.getElementById('examMsg').textContent='응시 확인 오류');
    };

    // 메뉴 – 리뷰 시작
    document.getElementById('menuReview').onclick=()=>{
      hideAllSections(); clearMessages(); hideReviewButtons();
      document.getElementById('reviewSection').classList.remove('hidden');
      document.getElementById('homeButton').classList.remove('hidden');
      fetch(`/api/review?exam=${encodeURIComponent(currentExam)}&id=${encodeURIComponent(currentId)}`)
      .then(r=>r.json()).then(d=>{
        wrongList=d.wrongList.map(x=>x.question);
        currentWrongIndex=0;
        showReviewQuestion(wrongList[0]);
      }).catch(()=>document.getElementById('reviewMsg').textContent='불러오기 오류');
    };

    // 한 문제 보여주기
    function showReviewQuestion(qno){
      clearMessages(); hideReviewButtons();
      // 문제 이미지
      const qi=document.getElementById('questionImage');
      qi.src=`/problem_images/${encodeURIComponent(currentExam)}/${qno}.png`;
      qi.classList.remove('hidden');
      // 숨김처리
      document.getElementById('explanationImage').classList.add('hidden');
      // 보기
      const cb=document.getElementById('choiceButtons'); cb.innerHTML='';
      [1,2,3,4,5].forEach(ch=>{
        const btn=document.createElement('button');
        btn.textContent=ch; btn.onclick=()=>handleAnswerClick(qno,ch,btn);
        cb.appendChild(btn);
      });
      // SKIP
      const skip=document.getElementById('skipButton');
      skip.classList.remove('hidden'); skip.onclick=nextQuestion;
    }

    // 답안 제출
    function handleAnswerClick(qno,sel,btn){
      clearMessages();
      fetch(`/api/submit_review?exam=${encodeURIComponent(currentExam)}&question=${qno}&answer=${sel}`)
      .then(r=>r.json()).then(d=>{
        // 피드백
        document.getElementById('feedback').textContent = d.correct?'정답입니다!':'오답입니다.';
        // 보기 비활성화
        document.querySelectorAll('#choiceButtons button').forEach(b=>b.disabled=true);
        // 버튼 표시
        const retry=document.getElementById('retryButton');
        const explain=document.getElementById('explainButton');
        retry.textContent = '다시 풀어보기'; retry.onclick=()=>showReviewQuestion(qno);
        explain.textContent = '해설 확인하기';
        explain.onclick = ()=>showExplanation(qno);
        retry.classList.remove('hidden');
        explain.classList.remove('hidden');
      }).catch(()=>document.getElementById('feedback').textContent='오류');
    }

    // 해설 보여주기
    function showExplanation(qno){
      const ei=document.getElementById('explanationImage');
      ei.src=`/exp_images/${encodeURIComponent(currentExam)}/${qno}.png`;
      ei.classList.remove('hidden');
    }

    // 다음 문제
    function nextQuestion(){
      currentWrongIndex++;
      if(currentWrongIndex<wrongList.length) showReviewQuestion(wrongList[currentWrongIndex]);
      else location.reload();
    }

    // 그 외 메뉴·성적표·OX버튼·홈 버튼 로직은 이전과 동일
  </script>
</body>
</html>
